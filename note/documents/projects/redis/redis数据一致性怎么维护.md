### Redis与MySQL的数据一致性怎么维护？

#### 一道面试题目

**修改数据库的时候，是要先操作缓存还是先操作数据库？**

> 最容易接受的是应该先操作数据库，再操作缓存。这种被称为是**旁路缓存策略**。

#### 选择旁路缓存策略的原因

对于数据库操作，大体上有四种顺序：

1. 先删除缓存，再操作数据库

2. 先操作数据库，再删除缓存

3. 先更新缓存，再操作数据库

4. 先操作数据库，再操作缓存

下面分析一下这些操作顺序存在的问题，**我们考虑的都是缓存中没有存在缓存的数据，即所有的读线程都要从数据库读取**

##### 先删除缓存，再操作数据库

这种情况考虑两个线程同时进入来操作数据库的情况。

A线程进来，删除了缓存，此时B线程进来读数据库，数据库此时还没有更新，又把脏数据放入到了缓存当中，A线程更新数据库，此时脏数据产生，数据库和缓存不一致了，而且这种情况是很大可能发生的，因为读操作的速度比写操作快很多，所以这种情况，产生脏数据的可能性是非常大的。

> **如果我非要选择先操作缓存，再操作数据库，有什么好的方法吗？**
> 
> 这种情况可以选择延时双删的策略：先删除缓存，再操作缓存，延迟一秒后再删除缓存。
> 
> 对比与原来的操作，这里多了一个延时一秒删除的操作，之所以要延迟一秒，就是保证读线程已经执行完了，然后再将缓存中的数据库删除，这样下次再读取的时候就直接去数据库中读取，保证了一致性。

##### 先操作数据库，再删除缓存

这种就是我们所说的旁路缓存策略，在大多数情况下是不会发生数据库与redis数据不一致的场景，但是考虑一种特殊情况：

- 此时缓存中没有数据，A线程中读取数据库

- B线程更新数据库

- B线程删除缓存

- A线程将脏数据放入缓存

这种情况可能是会产生不一致的，但是实际过程中，数据库的读操作远远比数据库的写操作要快的多，所以这种概率是非常小的。

> **那么这种情况怎么解决呢？**
> 
> 解决方法有两种：
> 
> - 我们可以接受这种暂时不一致的情况，可以通过给缓存设置一个过期时间，这样的话过期时间一到，就会强制从数据库读取，这样可以保证数据的最终一致性。
> 
> - 采用延迟删除的策略，延迟1s后删除缓存，这样可以保证读线程已经执行完了，可以确保即使有脏数据产生，那么我们通过延迟删除的方法可以解决这种问题。
> 
> 两种方法更倾向于采用第一种方法，因为既然采用缓存来保证数据，那么说明是可以接受数据的暂时的不一致的，如果要保证数据库与缓存的强一致性，就不应该采用缓存的策略，就应该直接查询数据库。

##### 先更新数据库，再更新缓存

A和B两个线程同时更新数据库，此时两个线程同时更新缓存，此时无法保证A、B两个线程的执行顺序，两者的操作的速度基本是一致的，因此数据库和缓存最终写入的是A还是B根本无法预估，系统大概率产生一致性文问题，主要是写入缓存的操作无法保证顺序。这种策略是我们无法接受的。

另外，我们也没必要去维护缓存的更新操作，因为这种是比较消耗性能的，因为缓存不知道什么时候再读取，把缓存的操作放到第一次读取的时候对性能更好。

##### 先更新缓存，再更新数据库

同样无法保证两个线程的执行顺序，无法保证缓存中的数据一致性。
